<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tickety</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        {% if profile %}
        <header class="app-header">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Tickety Logo" class="header-logo">
            <div class="profile-menu">
                <div class="profile-initials">{{ profile.first_name[0] }}{{ profile.last_name[0] }}</div>
                <div class="profile-dropdown">
                    <div class="dropdown-header">{{ profile.first_name }} {{ profile.last_name }}</div>
                    <a href="{{ url_for('setup_profile') }}"><span class="material-icons">edit</span> Edit Profile</a>
                </div>
            </div>
        </header>
        <main class="app-main">
            <div class="action-card" style="padding: 1rem;">
                <h2>Add a Ticket</h2>
                
                <!-- Ticket Form -->
                <form action="{{ url_for('generate_pdf') }}" method="POST" id="ticketForm">
                    <p>Enter ticket details:</p>
                    <div class="input-group">
                        <label for="ticket_number">Ticket Number</label>
                        <input type="text" id="ticket_number" name="ticket_number" required>
                    </div>
                    <div class="input-group">
                        <label for="space">Space Number</label>
                        <input type="text" id="space" name="space" required>
                    </div>
                    <div class="input-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="input-group">
                        <label for="start_time">Start Time</label>
                        <input type="time" id="start_time" name="start_time" required>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="form-actions-group">
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <span class="material-icons">picture_as_pdf</span> Generate PDF
                        </button>
                        <button type="button" class="btn btn-success" id="fightBtn">
                            <span class="material-icons">gavel</span> Fight Ticket
                        </button>
                    </div>
                </form>
                
                <div id="status" style="margin-top: 1rem; text-align: center; font-weight: 500;"></div>
            </div>
        </main>
        {% else %}
        <div class="signin-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Tickety Logo" class="signin-logo">
            </div>
            <p>Your digital ticket manager.</p>
            <a href="{{ url_for('setup_profile') }}" class="btn btn-primary">Set Up My Profile</a>
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ Page loaded');
            
            const generateBtn = document.getElementById('generateBtn');
            const fightBtn = document.getElementById('fightBtn');
            const ticketNumberInput = document.getElementById('ticket_number');
            const statusDiv = document.getElementById('status');
            
            function showStatus(message, type = 'info') {
                statusDiv.textContent = message;
                statusDiv.style.color = type === 'success' ? '#00C853' : type === 'error' ? '#F44336' : '#757575';
                setTimeout(() => statusDiv.textContent = '', 3000);
            }
            
            // Generate PDF Button
            if (generateBtn) {
                console.log('✅ Generate button found');
                generateBtn.addEventListener('click', function(e) {
                    console.log('Generate PDF clicked');
                    // Form will submit normally - no need to prevent default
                });
            }
            
            // Fight Ticket Button
            if (fightBtn && ticketNumberInput) {
                console.log('✅ Fight button found');
                fightBtn.addEventListener('click', function(e) {
                    console.log('Fight ticket clicked');
                    e.preventDefault();
                    
                    const ticketNumber = ticketNumberInput.value.trim();
                    
                    if (!ticketNumber) {
                        alert('Please enter a ticket number first.');
                        return;
                    }
                    
                    if (!/^\d{9}$/.test(ticketNumber)) {
                        alert('Please enter a valid 9-digit ticket number.');
                        return;
                    }
                    
                    // Show loading
                    const originalText = fightBtn.innerHTML;
                    fightBtn.disabled = true;
                    fightBtn.innerHTML = '<span class="material-icons">hourglass_empty</span> Opening Montreal Form...';
                    showStatus('Starting Montreal form automation...', 'info');
                    
                    // Call Selenium automation
                    fetch('/fight_ticket_selenium', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `ticket_number=${encodeURIComponent(ticketNumber)}`
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            showStatus('✅ ' + data.message, 'success');
                            alert('✅ ' + data.message);
                        } else {
                            showStatus('❌ ' + data.message, 'error');
                            alert('❌ ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        showStatus('❌ Failed to connect to server', 'error');
                        alert('❌ Failed to open Montreal form. Error: ' + error.message);
                    })
                    .finally(() => {
                        // Reset button
                        fightBtn.disabled = false;
                        fightBtn.innerHTML = originalText;
                    });
                });
            } else {
                console.log('❌ Fight button or ticket input not found');
            }
        });
    </script>
</body>
</html>
