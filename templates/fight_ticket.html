<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fight Ticket - Tickety</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Tickety Logo" class="header-logo">
            <h1>Fight Your Ticket</h1>
        </header>
        <main class="app-main">
            <div class="action-card" style="padding: 1rem;">
                <h2>Automated Ticket Dispute</h2>
                <p style="text-align: center; color: #757575; margin-bottom: 1.5rem;">
                    Multiple options to automatically fill the Montreal ticket dispute form.
                </p>
                
                <!-- Automation Options -->
                <div class="form-actions-group" style="margin-bottom: 2rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    {% if has_selenium_support %}
                    <button type="button" class="btn btn-primary" onclick="startLocalSelenium()" id="seleniumBtn">
                        <span class="material-icons">smart_toy</span>
                        Local Auto-Fill (Selenium)
                    </button>
                    {% endif %}
                    
                    <button type="button" class="btn btn-success" onclick="openFormWithPayload()">
                        <span class="material-icons">open_in_new</span>
                        Open + Bookmarklet
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="openManualForm()">
                        <span class="material-icons">launch</span>
                        Manual Fill
                    </button>
                </div>
                
                <!-- Bookmarklet Setup -->
                <div class="action-card" style="background: #f8f9fa; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #495057;">📚 Setup Bookmarklet (One-time)</h3>
                    <p style="color: #6c757d; margin-bottom: 1rem;">Drag this link to your bookmarks bar:</p>
                    <a href="#" id="bookmarkletLink" style="display: inline-block; background: #007bff; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; font-weight: bold;">🎯 Tickety AutoFill</a>
                    <p style="color: #6c757d; margin-top: 1rem; font-size: 0.9rem;">
                        <strong>How to use:</strong> 1) Drag the link above to bookmarks, 2) Click "Open + Bookmarklet", 3) On Montreal page, click the bookmark.
                    </p>
                </div>
                
                <div class="copy-group">
                    <label>Ticket Number</label>
                    <div class="input-wrapper">
                        <input type="text" value="{{ form_data.ticket_number }}" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('{{ form_data.ticket_number }}')">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                    </div>
                </div>

                <div class="copy-group">
                    <label>Your Name</label>
                    <div class="input-wrapper">
                        <input type="text" value="{{ form_data.first_name }} {{ form_data.last_name }}" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('{{ form_data.first_name }} {{ form_data.last_name }}')">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                    </div>
                </div>

                <div class="copy-group">
                    <label>Driver's License</label>
                    <div class="input-wrapper">
                        <input type="text" value="{{ form_data.license }}" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('{{ form_data.license }}')">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                    </div>
                </div>

                <div class="copy-group">
                    <label>Address</label>
                    <div class="input-wrapper">
                        <input type="text" value="{{ form_data.address }}" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('{{ form_data.address }}')">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                    </div>
                </div>

                <div class="copy-group">
                    <label>City</label>
                    <div class="input-wrapper">
                        <input type="text" value="{{ form_data.city }}" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('{{ form_data.city }}')">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                    </div>
                </div>

                <div class="copy-group">
                    <label>Postal Code</label>
                    <div class="input-wrapper">
                        <input type="text" value="{{ form_data.postal_code }}" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('{{ form_data.postal_code }}')">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                    </div>
                </div>
                
                <!-- Copy All Data Button -->
                <div class="copy-group" style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <label style="color: #1976d2; font-weight: bold;">📋 Copy All Data (for Bookmarklet Backup)</label>
                    <button class="copy-btn" style="width: 100%; margin-top: 0.5rem; border-radius: 8px; background: #2196f3;" onclick="copyAllPayload()">
                        <span class="material-icons">content_copy</span>
                        Copy All as Base64 JSON
                    </button>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">Use this if the bookmarklet can't read your data automatically.</p>
                </div>
                
                <!-- Troubleshooting -->
                <details style="margin-bottom: 1.5rem; border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
                    <summary style="cursor: pointer; font-weight: bold; color: #666;">🔧 Troubleshooting</summary>
                    <div style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                        <p><strong>If popups are blocked:</strong> Enable popups for this site in your browser settings.</p>
                        <p><strong>If bookmarklet doesn't work:</strong> Make sure your bookmarks bar is visible (Ctrl+Shift+B) and drag the blue link above to it.</p>
                        <p><strong>If Selenium doesn't work locally:</strong> Make sure ENABLE_SELENIUM=1 is set and requirements-dev.txt is installed.</p>
                        <p><strong>If Montreal page changes:</strong> The form fields might be updated. Contact support for updates.</p>
                    </div>
                </details>

                <div class="copy-group">
                    <label>Email</label>
                    <div class="input-wrapper">
                        <input type="text" value="{{ form_data.email }}" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('{{ form_data.email }}')">
                            <span class="material-icons">content_copy</span>
                            Copy
                        </button>
                    </div>
                </div>

                <div class="copy-group">
                    <label>Explanation</label>
                    <textarea readonly>{{ form_data.explanation }}</textarea>
                    <button class="copy-btn" style="width: 100%; margin-top: 0.5rem; border-radius: 8px;" onclick="copyToClipboard(`{{ form_data.explanation }}`)">
                        <span class="material-icons">content_copy</span>
                        Copy Explanation
                    </button>
                </div>

                <div id="status" style="margin-top: 1.5rem; text-align: center; font-weight: 500; padding: 1rem; border-radius: 8px; background: #f8f9fa;"></div>
            </div>
        </main>
    </div>

    <script>
        const formData = {
            ticketNumber: '{{ form_data.ticket_number }}',
            firstName: '{{ form_data.first_name }}',
            lastName: '{{ form_data.last_name }}',
            license: '{{ form_data.license }}',
            address: '{{ form_data.address }}',
            city: '{{ form_data.city }}',
            postalCode: '{{ form_data.postal_code }}',
            email: '{{ form_data.email }}',
            explanation: `{{ form_data.explanation }}`
        };
        
        const hasSeleniumSupport = {{ 'true' if has_selenium_support else 'false' }};

        // Enhanced status display with longer messages support
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.color = type === 'success' ? '#00C853' : (type === 'warning' ? '#FF9800' : '#F44336');
            status.style.fontSize = '0.9rem';
            status.style.lineHeight = '1.4';
            status.style.maxWidth = '100%';
            status.style.whiteSpace = 'pre-wrap';
            
            // Auto-clear after longer time for longer messages
            const clearTime = message.length > 100 ? 8000 : 5000;
            setTimeout(() => {
                status.textContent = '';
            }, clearTime);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                showStatus('Copied to clipboard!', 'success');
            }).catch(function(err) {
                showStatus('Failed to copy', 'error');
                console.error('Copy failed:', err);
            });
        }
        
        function copyAllPayload() {
            const payload = btoa(JSON.stringify(formData));
            copyToClipboard(payload);
            showStatus('Full data copied as base64. Paste this into the bookmarklet if needed.', 'success');
        }
        
        // 1. SELENIUM LOCAL AUTOMATION (when available)
        async function startLocalSelenium() {
            if (!hasSeleniumSupport) {
                showStatus('Selenium not available in this environment.', 'error');
                return;
            }
            
            try {
                showStatus('🤖 Starting local Chrome automation...', 'success');
                
                const response = await fetch('/fight_ticket_selenium', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ticket_number: formData.ticketNumber,
                        first_name: formData.firstName,
                        last_name: formData.lastName,
                        license: formData.license,
                        address: formData.address,
                        city: formData.city,
                        postal_code: formData.postalCode,
                        email: formData.email,
                        explanation: formData.explanation
                    })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showStatus(`✅ ${result.message}`, 'success');
                } else {
                    const errorMsg = result.error || 'Unknown error';
                    showStatus(`❌ Selenium Failed: ${errorMsg}\n\n💡 Try the "Open + Bookmarklet" button instead - it works on any browser!`, 'error');
                    
                    // Highlight the bookmarklet button as alternative
                    const bookmarkletBtn = document.querySelector('button[onclick="openFormWithPayload()"]');
                    if (bookmarkletBtn) {
                        bookmarkletBtn.style.animation = 'pulse 2s infinite';
                        bookmarkletBtn.style.boxShadow = '0 0 15px #28a745';
                        setTimeout(() => {
                            bookmarkletBtn.style.animation = '';
                            bookmarkletBtn.style.boxShadow = '';
                        }, 6000);
                    }
                }
                
            } catch (error) {
                console.error('Selenium request failed:', error);
                showStatus(`❌ Local automation failed: ${error.message}\n\n💡 Try the "Open + Bookmarklet" button instead!`, 'error');
                
                // Log full error details for debugging
                console.log('Full error details:', {
                    message: error.message,
                    stack: error.stack,
                    response: response?.status,
                    responseText: response?.statusText
                });
                
                // Highlight the working bookmarklet button
                const bookmarkletBtn = document.querySelector('button[onclick="openFormWithPayload()"]');
                if (bookmarkletBtn) {
                    bookmarkletBtn.style.animation = 'pulse 2s infinite';
                    bookmarkletBtn.style.boxShadow = '0 0 15px #28a745';
                    setTimeout(() => {
                        bookmarkletBtn.style.animation = '';
                        bookmarkletBtn.style.boxShadow = '';
                    }, 6000);
                }
            }
        }
        
        // 2. PAYLOAD + BOOKMARKLET METHOD (works everywhere)
        function openFormWithPayload() {
            const payload = btoa(JSON.stringify(formData));
            const targetWindow = window.open('about:blank', '_blank');
            
            if (!targetWindow) {
                showStatus('Popup blocked! Please allow popups for this site and try again.', 'error');
                return;
            }
            
            // Set payload in window name for bookmarklet to read
            targetWindow.name = 'TICKETY|' + payload;
            targetWindow.location.href = 'https://services.montreal.ca/plaidoyer/rechercher/en';
            
            showStatus('✅ Montreal page opened with your data. Now click the "Tickety AutoFill" bookmark on that page.', 'success');
        }
        
        // 3. MANUAL FORM OPENING (fallback)
        function openManualForm() {
            const targetWindow = window.open('https://services.montreal.ca/plaidoyer/rechercher/en', '_blank');
            
            if (!targetWindow) {
                showStatus('Popup blocked! Please allow popups and try again.', 'error');
                return;
            }
            
            showStatus('✅ Montreal form opened. Use the copy buttons below to fill manually.', 'success');
        }
        
        // 4. LEGACY CROSS-ORIGIN ATTEMPT (experimental, usually blocked)
        function openAndFillForm() {
            const targetWindow = window.open('https://services.montreal.ca/plaidoyer/rechercher/en', '_blank');
            
            if (!targetWindow) {
                showStatus('Popup blocked! Please allow popups and try again.', 'error');
                return;
            }
            
            try {
                // This will throw due to cross-origin restrictions
                void targetWindow.document.domain;
                showStatus('✅ Unexpected: Direct autofill might work! Trying in 3 seconds...', 'success');
                // If we get here, try the legacy method
                setTimeout(() => attemptLegacyFill(targetWindow), 3000);
            } catch (e) {
                showStatus('⚠️ Cross-origin blocked (expected). Use Selenium locally or the Bookmarklet method.', 'warning');
            }
        }
        
        function attemptLegacyFill(targetWindow) {
            try {
                // This legacy code is kept for reference but likely won't work
                const ticketInput = targetWindow.document.querySelector('#searchTxtStatementNo');
                if (ticketInput) {
                    ticketInput.value = formData.ticketNumber;
                    showStatus('Legacy autofill working!', 'success');
                } else {
                    showStatus('Could not access Montreal form fields', 'error');
                }
            } catch (error) {
                showStatus('Legacy autofill blocked by browser security', 'error');
            }
        }
        
        // Check if Selenium is working by testing the endpoint
        async function checkSeleniumStatus() {
            if (!hasSeleniumSupport) return false;
            
            try {
                const response = await fetch('/debug_selenium');
                const data = await response.json();
                return data.selenium_route_active === true;
            } catch (error) {
                return false;
            }
        }
        
        // Initialize bookmarklet link on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const bookmarkletCode = `javascript:(()=>{try{const P='TICKETY|';const raw=(window.name&&window.name.startsWith(P))?window.name.slice(P.length):prompt('Paste Tickety payload (base64 JSON):','');if(!raw){alert('Tickety: No data provided');return;}const d=JSON.parse(atob(raw));const wait=(selector,timeout=10000)=>new Promise(resolve=>{const start=Date.now();const check=()=>{const el=document.querySelector(selector);if(el){resolve(el);}else if(Date.now()-start<timeout){setTimeout(check,200);}else{resolve(null);}};check();});const fill=(selector,value)=>{const el=document.querySelector(selector);if(el&&value){el.value=value;el.dispatchEvent(new Event('input',{bubbles:true}));el.dispatchEvent(new Event('change',{bubbles:true}));return true;}return false;};console.log('Tickety: Starting autofill...');fill('#searchTxtStatementNo',d.ticketNumber);const searchBtn=document.querySelector('#searchBtnSubmit');if(searchBtn){searchBtn.click();console.log('Tickety: Search clicked');}wait('#firstName',15000).then(()=>{console.log('Tickety: Personal info form loaded');const whoDropdown=document.querySelector('#who');if(whoDropdown){whoDropdown.value='1';whoDropdown.dispatchEvent(new Event('change',{bubbles:true}));}let filled=0;filled+=fill('#firstName',d.firstName)?1:0;filled+=fill('#lastName',d.lastName)?1:0;filled+=fill('#licenceNumber',d.license)?1:0;filled+=fill('#address',d.address)?1:0;filled+=fill('#city',d.city)?1:0;filled+=fill('#postalCode',d.postalCode)?1:0;filled+=fill('#email',d.email)?1:0;filled+=fill('#confEmail',d.email)?1:0;filled+=fill('#explanation',d.explanation)?1:0;alert('Tickety: Filled '+filled+' fields. Please review and submit manually.');}).catch(e=>alert('Tickety: Could not find personal info form. Try refreshing and running again.'));}catch(e){alert('Tickety error: '+e.message);}})();`;
            
            const bookmarkletLink = document.getElementById('bookmarkletLink');
            if (bookmarkletLink) {
                bookmarkletLink.href = bookmarkletCode;
                bookmarkletLink.title = 'Drag this to your bookmarks bar';
            }
        });
    </script>
</body>
</html>
