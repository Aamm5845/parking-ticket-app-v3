<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tickety</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        {% if profile %}
        <header class="app-header">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Tickety Logo" class="header-logo">
            <div class="profile-menu">
                <div class="profile-initials">{{ profile.first_name[0] }}{{ profile.last_name[0] }}</div>
                <div class="profile-dropdown">
                    <div class="dropdown-header">{{ profile.first_name }} {{ profile.last_name }}</div>
                    <a href="{{ url_for('setup_profile') }}"><span class="material-icons">edit</span> Edit Profile</a>
                </div>
            </div>
        </header>
        <main class="app-main">
            <div class="action-card" style="padding: 1rem;">
                <h2>Add a Ticket</h2>
                
                <!-- Scan Ticket Buttons -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" id="webcamScanBtn">
                        <span class="material-icons">videocam</span> Use Webcam
                    </button>
                    <button type="button" class="btn btn-secondary" id="fileScanBtn">
                        <span class="material-icons">photo_camera</span> Upload Photo
                    </button>
                    <input type="file" id="ticket_image" name="ticket_image" accept="image/*" capture="environment" style="display: none;">
                </div>
                
                <!-- Webcam Modal -->
                <div id="webcamModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>üì∑ Capture Ticket Photo</h3>
                            <button class="close-btn" id="closeWebcam">&times;</button>
                        </div>
                        <div class="modal-body">
                            <video id="webcamVideo" autoplay playsinline style="width: 100%; max-width: 500px; border-radius: 8px;"></video>
                            <canvas id="webcamCanvas" style="display: none;"></canvas>
                            <div class="webcam-controls" style="margin-top: 1rem; text-align: center;">
                                <button type="button" class="btn btn-primary" id="captureBtn">
                                    <span class="material-icons">camera</span> Capture Photo
                                </button>
                                <button type="button" class="btn btn-secondary" id="retakeBtn" style="display: none;">
                                    <span class="material-icons">refresh</span> Retake
                                </button>
                                <button type="button" class="btn btn-success" id="usePhotoBtn" style="display: none;">
                                    <span class="material-icons">check</span> Use This Photo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="divider">OR</div>
                
                <!-- Ticket Form -->
                <form action="{{ url_for('generate_pdf') }}" method="POST" id="ticketForm">
                    <p>Enter ticket details:</p>
                    <div class="input-group">
                        <label for="ticket_number">Ticket Number</label>
                        <input type="text" id="ticket_number" name="ticket_number" required>
                    </div>
                    <div class="input-group">
                        <label for="space">Space Number</label>
                        <input type="text" id="space" name="space" required>
                    </div>
                    <div class="input-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="input-group">
                        <label for="start_time">Start Time</label>
                        <input type="time" id="start_time" name="start_time" required>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="form-actions-group">
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <span class="material-icons">picture_as_pdf</span> Generate PDF
                        </button>
                        <button type="button" class="btn btn-success" id="fightBtn">
                            <span class="material-icons">gavel</span> Fight Ticket
                        </button>
                    </div>
                </form>
                
                <div id="status" style="margin-top: 1rem; text-align: center; font-weight: 500;"></div>
            </div>
        </main>
        {% else %}
        <div class="signin-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Tickety Logo" class="signin-logo">
            </div>
            <p>Your digital ticket manager.</p>
            <a href="{{ url_for('setup_profile') }}" class="btn btn-primary">Set Up My Profile</a>
        </div>
        {% endif %}
    </div>
    
    <!-- Scanning Overlay -->
    <div id="scanning_overlay" class="scanning-overlay">
        <img src="{{ url_for('static', filename='Material wave loading.gif') }}" alt="Scanning...">
        <p>Scanning ticket...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Page loaded');
            
            const generateBtn = document.getElementById('generateBtn');
            const fightBtn = document.getElementById('fightBtn');
            const ticketNumberInput = document.getElementById('ticket_number');
            const statusDiv = document.getElementById('status');
            const webcamScanBtn = document.getElementById('webcamScanBtn');
            const fileScanBtn = document.getElementById('fileScanBtn');
            const ticketImageInput = document.getElementById('ticket_image');
            const scanningOverlay = document.getElementById('scanning_overlay');
            const webcamModal = document.getElementById('webcamModal');
            const webcamVideo = document.getElementById('webcamVideo');
            const webcamCanvas = document.getElementById('webcamCanvas');
            const captureBtn = document.getElementById('captureBtn');
            const retakeBtn = document.getElementById('retakeBtn');
            const usePhotoBtn = document.getElementById('usePhotoBtn');
            const closeWebcam = document.getElementById('closeWebcam');
            
            let currentStream = null;
            let capturedImageBlob = null;
            
            function showStatus(message, type = 'info') {
                statusDiv.textContent = message;
                statusDiv.style.color = type === 'success' ? '#00C853' : type === 'error' ? '#F44336' : '#757575';
                setTimeout(() => statusDiv.textContent = '', 3000);
            }
            
            // Webcam functionality
            function stopWebcamStream() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
            }
            
            function processTicketImage(imageBlob) {
                const formData = new FormData();
                formData.append('ticket_image', imageBlob, 'ticket.jpg');
                
                // Hide webcam modal and show loading
                webcamModal.style.display = 'none';
                scanningOverlay.style.display = 'flex';
                showStatus('Scanning ticket...', 'info');
                
                fetch('/scan-ticket', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    // Hide loading overlay
                    scanningOverlay.style.display = 'none';
                    
                    if (data.success) {
                        document.getElementById('ticket_number').value = data.ticket_number || '';
                        document.getElementById('space').value = data.space || '';
                        document.getElementById('date').value = data.date || '';
                        document.getElementById('start_time').value = data.start_time || '';
                        
                        const successMsg = data.message || 'Ticket scanned successfully!';
                        showStatus('‚úÖ ' + successMsg, 'success');
                    } else {
                        showStatus('‚ùå OCR failed: ' + (data.message || 'Could not extract information.'), 'error');
                    }
                })
                .catch(err => {
                    // Hide loading overlay
                    scanningOverlay.style.display = 'none';
                    console.error('Scan error:', err);
                    showStatus('‚ùå Error during scan.', 'error');
                });
            }
            
            // Webcam scan button
            if (webcamScanBtn) {
                console.log('‚úÖ Webcam scan button found');
                webcamScanBtn.addEventListener('click', async () => {
                    try {
                        currentStream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: 'environment' // Try to use back camera on mobile
                            } 
                        });
                        webcamVideo.srcObject = currentStream;
                        webcamModal.style.display = 'flex';
                        
                        // Reset UI state
                        captureBtn.style.display = 'inline-block';
                        retakeBtn.style.display = 'none';
                        usePhotoBtn.style.display = 'none';
                        webcamVideo.style.display = 'block';
                        
                    } catch (err) {
                        console.error('Error accessing webcam:', err);
                        showStatus('‚ùå Could not access webcam. Please check permissions.', 'error');
                    }
                });
            }
            
            // File upload scan button
            if (fileScanBtn && ticketImageInput) {
                console.log('‚úÖ File scan button found');
                fileScanBtn.addEventListener('click', () => {
                    ticketImageInput.click();
                });
                
                ticketImageInput.addEventListener('change', event => {
                    const file = event.target.files[0];
                    if (file) {
                        processTicketImage(file);
                    }
                });
            }
            
            // Webcam controls
            if (captureBtn && webcamCanvas) {
                captureBtn.addEventListener('click', () => {
                    const context = webcamCanvas.getContext('2d');
                    webcamCanvas.width = webcamVideo.videoWidth;
                    webcamCanvas.height = webcamVideo.videoHeight;
                    
                    context.drawImage(webcamVideo, 0, 0);
                    
                    // Convert to blob
                    webcamCanvas.toBlob(blob => {
                        capturedImageBlob = blob;
                        
                        // Update UI
                        webcamVideo.style.display = 'none';
                        captureBtn.style.display = 'none';
                        retakeBtn.style.display = 'inline-block';
                        usePhotoBtn.style.display = 'inline-block';
                        
                        // Show captured image
                        webcamCanvas.style.display = 'block';
                        
                    }, 'image/jpeg', 0.8);
                });
            }
            
            if (retakeBtn) {
                retakeBtn.addEventListener('click', () => {
                    // Reset to video mode
                    webcamVideo.style.display = 'block';
                    webcamCanvas.style.display = 'none';
                    captureBtn.style.display = 'inline-block';
                    retakeBtn.style.display = 'none';
                    usePhotoBtn.style.display = 'none';
                    capturedImageBlob = null;
                });
            }
            
            if (usePhotoBtn) {
                usePhotoBtn.addEventListener('click', () => {
                    if (capturedImageBlob) {
                        stopWebcamStream();
                        processTicketImage(capturedImageBlob);
                    }
                });
            }
            
            if (closeWebcam) {
                closeWebcam.addEventListener('click', () => {
                    stopWebcamStream();
                    webcamModal.style.display = 'none';
                    capturedImageBlob = null;
                });
            }
            
            // Close modal when clicking outside
            webcamModal.addEventListener('click', (e) => {
                if (e.target === webcamModal) {
                    stopWebcamStream();
                    webcamModal.style.display = 'none';
                    capturedImageBlob = null;
                }
            });
            
            // Generate PDF Button
            if (generateBtn) {
                console.log('‚úÖ Generate button found');
                generateBtn.addEventListener('click', function(e) {
                    console.log('Generate PDF clicked');
                    // Form will submit normally - no need to prevent default
                });
            }
            
            // Fight Ticket Button - redirect to enhanced form
            if (fightBtn && ticketNumberInput) {
                console.log('‚úÖ Fight button found');
                fightBtn.addEventListener('click', function(e) {
                    console.log('Fight ticket clicked');
                    e.preventDefault();
                    
                    const ticketNumber = ticketNumberInput.value.trim();
                    
                    if (!ticketNumber) {
                        alert('Please enter a ticket number first.');
                        return;
                    }
                    
                    if (!/^\d{9}$/.test(ticketNumber)) {
                        alert('Please enter a valid 9-digit ticket number.');
                        return;
                    }
                    
                    // Redirect to enhanced fight ticket form
                    showStatus('Opening enhanced fight ticket form...', 'info');
                    window.location.href = `/fight_ticket_form?ticket_number=${encodeURIComponent(ticketNumber)}`;
                });
            } else {
                console.log('‚ùå Fight button or ticket input not found');
            }
        });
    </script>
</body>
</html>
